<div class="container max-w-full p-4">
  <p-toast></p-toast>

  <!-- Loading Spinner -->
  <div *ngIf="loading" class="flex items-center justify-center h-64">
    <p-progressSpinner></p-progressSpinner>
  </div>

  <!-- Header -->
  <div *ngIf="!loading" class="flex flex-col gap-4 mb-4 md:flex-row md:items-center md:justify-between">
    <h2 class="text-3xl font-bold text-blue-900">
      รายการนักศึกษาฝึกงาน
    </h2>
    <div class="flex gap-2">
      <p-button
        icon="pi pi-th-large"
        [outlined]="viewMode !== 'card'"
        (onClick)="viewMode = 'card'"
        [rounded]="true"
        severity="info"
        pTooltip="Card View"
      ></p-button>
      <p-button
        icon="pi pi-list"
        [outlined]="viewMode !== 'list'"
        (onClick)="viewMode = 'list'"
        [rounded]="true"
        severity="info"
        pTooltip="List View"
      ></p-button>
    </div>
  </div>

  <!-- Department Filter -->
  <div *ngIf="!loading" class="p-4 mb-4 bg-white border border-gray-200 rounded-lg shadow-sm">
    <div class="flex items-center gap-3 mb-3">
      <i class="text-xl text-purple-600 pi pi-filter"></i>
      <h3 class="text-lg font-semibold text-gray-800">กรองตามแผนก</h3>
      <span class="px-3 py-1 text-sm font-medium text-blue-700 bg-blue-100 rounded-full">
        {{ filteredStudents.length }} / {{ students.length }} คน
      </span>
    </div>

    <div class="flex flex-wrap gap-2">
      <p-button
        *ngFor="let dept of departments"
        [label]="dept.label + ' (' + dept.count + ')'"
        [icon]="dept.icon"
        (onClick)="filterByDepartment(dept.value)"
        [outlined]="selectedDepartment !== dept.value"
        [severity]="selectedDepartment === dept.value ? 'primary' : 'secondary'"
        size="small"
        styleClass="transition-all duration-200"
      ></p-button>
    </div>
  </div>

  <!-- Card View -->
  <div *ngIf="!loading && viewMode === 'card'" class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
    <div
      *ngFor="let student of filteredStudents"
      class="overflow-hidden transition-all duration-300 bg-white border border-gray-200 rounded-lg shadow-md hover:shadow-xl hover:-translate-y-1"
    >
      <!-- Profile Image -->
      <div class="relative h-48 overflow-hidden bg-gradient-to-br from-purple-100 to-blue-100">
        <img
          *ngIf="student.profile_file"
          [src]="getImageUrl(student.profile_file)"
          [alt]="student.fullname"
          class="object-cover w-full h-full"
        />
        <div
          *ngIf="!student.profile_file"
          class="flex items-center justify-center w-full h-full"
        >
          <i class="text-6xl text-gray-400 pi pi-user"></i>
        </div>

        <!-- Grade Badge -->
        <div
          *ngIf="student.grade"
          class="absolute px-3 py-1 font-bold text-white rounded-full shadow-lg top-3 right-3"
          [ngClass]="getGradeBadgeClass(student.grade)"
        >
          {{ student.grade }}
        </div>

        <!-- Status Badge -->
        <div class="absolute px-3 py-1 text-xs font-semibold text-white bg-green-500 rounded-full shadow-lg bottom-3 left-3">
          <i class="mr-1 pi pi-check-circle"></i>
          ฝึกงาน
        </div>
      </div>

      <!-- Card Body -->
      <div class="p-4">
        <!-- Name -->
        <h3 class="mb-2 text-lg font-bold text-blue-900 truncate" [title]="student.fullname">
          {{ student.fullname }}
        </h3>

        <!-- University Info -->
        <div class="mb-3 space-y-1 text-sm text-gray-600">
          <div class="flex items-start gap-2">
            <i class="flex-shrink-0 mt-1 text-purple-600 pi pi-building"></i>
            <span class="line-clamp-2" [title]="student.university">{{ student.university }}</span>
          </div>
          <div class="flex items-start gap-2">
            <i class="flex-shrink-0 mt-1 text-blue-600 pi pi-book"></i>
            <span class="line-clamp-1" [title]="student.faculty + ' - ' + student.major">
              {{ student.faculty }}
            </span>
          </div>
        </div>

        <!-- Duration & Department -->
        <div class="pb-3 mb-3 space-y-2 text-sm border-b border-gray-200">
          <div class="flex items-center gap-2 text-gray-700">
            <i class="text-orange-500 pi pi-briefcase"></i>
            <span class="truncate" [title]="student.intern_department">
              {{ student.intern_department }}
            </span>
          </div>
          <div class="flex items-center gap-2 text-gray-700">
            <i class="text-green-500 pi pi-calendar"></i>
            <span class="truncate" [title]="student.intern_duration">
              {{ student.intern_duration }}
            </span>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex gap-2">
          <p-button
            label="ดูข้อมูล"
            icon="pi pi-eye"
            (onClick)="viewStudentDetails(student)"
            [outlined]="true"
            size="small"
            styleClass="flex-1"
            severity="info"
          ></p-button>
        </div>
      </div>
    </div>
  </div>

  <!-- List View (Table) -->
  <div *ngIf="!loading && viewMode === 'list'">
    <p-table
      [value]="students"
      [paginator]="true"
      [rows]="10"
      [rowHover]="true"
      stripedRows
      [tableStyle]="{'min-width': '80rem'}"
    >
      <ng-template pTemplate="header">
        <tr>
          <th style="width: 5%">ลำดับ</th>
          <th style="width: 15%">ชื่อ-นามสกุล</th>
          <th style="width: 15%">มหาวิทยาลัย</th>
          <th style="width: 12%">คณะ</th>
          <th style="width: 12%">แผนกฝึกงาน</th>
          <th style="width: 12%">ระยะเวลา</th>
          <th style="width: 8%" class="text-center">เกรด</th>
          <th style="width: 10%" class="text-center">จัดการ</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-student let-rowIndex="rowIndex">
        <tr>
          <td class="text-center">{{ rowIndex + 1 }}</td>
          <td>{{ student.fullname }}</td>
          <td>{{ student.university }}</td>
          <td>{{ student.faculty }}</td>
          <td>{{ student.intern_department }}</td>
          <td>{{ student.intern_duration }}</td>
          <td class="text-center">
            <span [class]="getGradeColor(student.grade)" class="font-semibold">
              {{ student.grade || '-' }}
            </span>
          </td>
          <td class="text-center">
            <p-button
              icon="pi pi-eye"
              (onClick)="viewStudentDetails(student)"
              [outlined]="true"
              [rounded]="true"
              size="small"
              severity="info"
              pTooltip="ดูข้อมูล"
            ></p-button>
            <p-button
              *ngIf="isAdmin || isMyStudent(student)"
              icon="pi pi-pencil"
              (onClick)="editStudent(student.id)"
              [outlined]="true"
              [rounded]="true"
              size="small"
              severity="success"
              class="ml-2"
              pTooltip="แก้ไข"
            ></p-button>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <!-- Empty State -->
  <div *ngIf="!loading && students.length === 0" class="py-20 text-center text-gray-500">
    <i class="mb-4 text-6xl pi pi-inbox"></i>
    <p class="text-xl">ไม่พบข้อมูลนักศึกษา</p>
  </div>
</div>


<!-- Student Detail Dialog -->
<p-dialog
  [(visible)]="showDetailDialog"
  [modal]="true"
  [style]="{
    'width': '90vw',
    'max-width': '900px',
    'height': 'auto',
    'max-height': '90vh'
  }"
  [header]="'ข้อมูลนักศึกษา: ' + (selectedStudent?.fullname || '')"
  [draggable]="false"
  [resizable]="false"
  [blockScroll]="true"
  appendTo="body"
  [contentStyle]="{
    'max-height': 'calc(90vh - 140px)',
    'overflow-y': 'auto',
    'padding': '1rem'
  }"
    [breakpoints]="{'960px': '90vw', '640px': '95vw'}"

>
  <div *ngIf="selectedStudent" class="p-4">
    <div class="grid grid-cols-1 gap-6 md:grid-cols-3">
      <!-- Left Column: Profile Image & Basic Info -->
      <div class="space-y-4">
        <!-- Profile Image -->
        <div class="overflow-hidden border-4 border-purple-200 rounded-lg shadow-xl">
          <img
            *ngIf="selectedStudent.profile_file"
            [src]="getImageUrl(selectedStudent.profile_file)"
            [alt]="selectedStudent.fullname"
            class="object-cover w-full h-64"
          />
          <div
            *ngIf="!selectedStudent.profile_file"
            class="flex items-center justify-center w-full h-64 bg-gradient-to-br from-purple-100 to-blue-100"
          >
            <i class="text-gray-400 text-8xl pi pi-user"></i>
          </div>
        </div>

        <!-- Grade Display -->
        <div
          *ngIf="selectedStudent.grade"
          class="p-4 text-center rounded-lg bg-gradient-to-r from-purple-100 to-blue-100"
        >
          <p class="text-sm text-gray-600">เกรด</p>
          <p [class]="getGradeColor(selectedStudent.grade)" class="text-4xl font-bold">
            {{ selectedStudent.grade }}
          </p>
        </div>
      </div>

      <!-- Right Column: Detailed Information -->
      <div class="space-y-4 md:col-span-2">
        <!-- Personal Info Section -->
        <div class="p-4 border-l-4 border-purple-500 rounded-lg bg-purple-50">
          <h4 class="mb-3 text-lg font-bold text-purple-900">
            <i class="mr-2 pi pi-user"></i>ข้อมูลส่วนตัว
          </h4>
          <div class="space-y-2">
            <div class="grid grid-cols-3 gap-2">
              <span class="font-semibold text-gray-700">ชื่อ-นามสกุล:</span>
              <span class="col-span-2 text-gray-900">{{ selectedStudent.fullname }}</span>
            </div>
            <div class="grid grid-cols-3 gap-2">
              <span class="font-semibold text-gray-700">อีเมล:</span>
              <span class="col-span-2 text-blue-600">{{ selectedStudent.email }}</span>
            </div>
            <div class="grid grid-cols-3 gap-2">
              <span class="font-semibold text-gray-700">เบอร์โทร:</span>
              <span class="col-span-2 text-gray-900">{{ selectedStudent.contact_number }}</span>
            </div>
          </div>
        </div>

        <!-- Education Info Section -->
        <div class="p-4 border-l-4 border-blue-500 rounded-lg bg-blue-50">
          <h4 class="mb-3 text-lg font-bold text-blue-900">
            <i class="mr-2 pi pi-building"></i>ข้อมูลการศึกษา
          </h4>
          <div class="space-y-2">
            <div class="grid grid-cols-3 gap-2">
              <span class="font-semibold text-gray-700">มหาวิทยาลัย:</span>
              <span class="col-span-2 text-gray-900">{{ selectedStudent.university }}</span>
            </div>
            <div class="grid grid-cols-3 gap-2">
              <span class="font-semibold text-gray-700">คณะ:</span>
              <span class="col-span-2 text-gray-900">{{ selectedStudent.faculty }}</span>
            </div>
            <div class="grid grid-cols-3 gap-2">
              <span class="font-semibold text-gray-700">สาขา:</span>
              <span class="col-span-2 text-gray-900">{{ selectedStudent.major }}</span>
            </div>
          </div>
        </div>

        <!-- Internship Info Section -->
        <div class="p-4 border-l-4 border-green-500 rounded-lg bg-green-50">
          <h4 class="mb-3 text-lg font-bold text-green-900">
            <i class="mr-2 pi pi-briefcase"></i>ข้อมูลการฝึกงาน
          </h4>
          <div class="space-y-2">
            <div class="grid grid-cols-3 gap-2">
              <span class="font-semibold text-gray-700">แผนก:</span>
              <span class="col-span-2 text-gray-900">{{ selectedStudent.intern_department }}</span>
            </div>
            <div class="grid grid-cols-3 gap-2">
              <span class="font-semibold text-gray-700">ระยะเวลา:</span>
              <span class="col-span-2 text-gray-900">{{ selectedStudent.intern_duration }}</span>
            </div>
          </div>
        </div>

        <!-- Project File Section -->
        <div
          *ngIf="selectedStudent.project_file"
          class="p-4 border-l-4 border-orange-500 rounded-lg bg-orange-50"
        >
          <h4 class="mb-3 text-lg font-bold text-orange-900">
            <i class="mr-2 pi pi-file"></i>โครงการ/ผลงาน
          </h4>
          <div class="flex items-center justify-between p-3 bg-white rounded-md">
            <div class="flex items-center flex-1 min-w-0 gap-2">
              <i class="text-2xl text-orange-500 pi pi-file-pdf"></i>
              <span class="text-sm text-gray-900 truncate" [title]="getFileName(selectedStudent.project_file)">
                {{ getFileName(selectedStudent.project_file) }}
              </span>
            </div>
            <p-button
              icon="pi pi-download"
              label="ดาวน์โหลด"
              (onClick)="downloadProject(selectedStudent)"
              size="small"
              severity="warn"
            ></p-button>
          </div>
        </div>
      </div>
    </div>
  </div>

<ng-template pTemplate="footer">
  <div class="flex flex-col items-end justify-end w-full gap-3 sm:flex-row sm:items-center">
    <!-- Grade Display for Non-Admin -->
    <div *ngIf="!isAdmin && selectedStudent" class="px-4 py-2 mr-auto bg-gray-100 rounded-lg sm:mr-0">
      <span class="text-sm text-gray-600">เกรด: </span>
      <span class="text-lg font-semibold" [class]="getGradeColor(selectedStudent.grade)">
        {{ selectedStudent.grade || '-' }}
      </span>
    </div>

    <!-- Action Buttons -->
    <div class="flex flex-col w-full gap-2 sm:w-auto sm:flex-row">
      <p-button
        *ngIf="selectedStudent && (isAdmin || isMyStudent(selectedStudent))"
        label="แก้ไขข้อมูล"
        icon="pi pi-pencil"
        (onClick)="editStudent(selectedStudent.id)"
        severity="success"
        styleClass="w-full sm:w-auto"
      ></p-button>

      <div class="w-32 sm:w-32">
        <p-select
          *ngIf="isAdmin && selectedStudent"
          [(ngModel)]="selectedStudent.grade"
          [options]="gradeOptions"
          optionLabel="label"
          optionValue="value"
          placeholder="เลือกเกรด"
          (onChange)="onGradeChange(selectedStudent)"
          appendTo="body"
          [styleClass]="'custom-grade-select w-full'"
          [panelStyleClass]="'custom-grade-panel'"
        ></p-select>
      </div>
    </div>
  </div>
</ng-template>
</p-dialog>
